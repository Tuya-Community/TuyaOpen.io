"use strict";(self.webpackChunktuyaopen_io_website=self.webpackChunktuyaopen_io_website||[]).push([["9710"],{2228(e,t,n){n.r(t),n.d(t,{metadata:()=>r,default:()=>h,frontMatter:()=>o,contentTitle:()=>s,toc:()=>l,assets:()=>d});var r=JSON.parse('{"id":"new-hardware/porting-platform","title":"Adapt to New Platforms","description":"Overview","source":"@site/docs/new-hardware/porting-platform.md","sourceDirName":"new-hardware","slug":"/new-hardware/porting-platform","permalink":"/docs/new-hardware/porting-platform","draft":false,"unlisted":false,"editUrl":"https://github.com/Tuya-Community/TuyaOpen.io/edit/master/docs/new-hardware/porting-platform.md","tags":[],"version":"current","frontMatter":{"title":"Adapt to New Platforms"},"sidebar":"docs","previous":{"title":"Button Driver","permalink":"/docs/peripheral/button"},"next":{"title":"Create platform","permalink":"/docs/new-hardware/new-platform"}}'),i=n(4848),a=n(8453);let o={title:"Adapt to New Platforms"},s,d={},l=[{value:"Overview",id:"overview",level:2},{value:"Build process",id:"build-process",level:3},{value:"Create a platform",id:"create-a-platform",level:2},{value:"TKL layer adaptation",id:"tkl-layer-adaptation",level:2},{value:"Adapt TKL interfaces for cellular networks",id:"adapt-tkl-interfaces-for-cellular-networks",level:3},{value:"Create a board",id:"create-a-board",level:2},{value:"Verify functionality",id:"verify-functionality",level:2}];function c(e){let t={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(t.p,{children:"This topic describes the required readings, operational steps, and verification procedures for adding support for a new chipset on the TuyaOpen platform."}),"\n",(0,i.jsxs)(t.p,{children:["If you are new to TuyaOpen, it is recommended first to read ",(0,i.jsx)(t.a,{href:"/docs/quick-start/",children:"Get Started"}),". Follow the tutorial to set up and test the ",(0,i.jsx)(t.code,{children:"switch_demo"})," application (an Ubuntu environment is recommended) to understand and familiarize yourself with Tuya IoT's pairing and operational logic. Additionally, please read the ",(0,i.jsx)(t.a,{href:"/docs/tos-tools/tos-guide",children:"tos.py User Guide"})," to learn about the usage and functionality of ",(0,i.jsx)(t.code,{children:"tos.py"})," commands."]}),"\n",(0,i.jsx)(t.h3,{id:"build-process",children:"Build process"}),"\n",(0,i.jsx)(t.p,{children:"Before adapting a new chipset, it is helpful to understand the TuyaOpen build flow briefly:"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:["First, build the application (using ",(0,i.jsx)(t.code,{children:"switch_demo"})," as an example, located under ",(0,i.jsx)(t.code,{children:"TuyaOpen/apps/tuya_cloud/switch_demo"}),") and the TuyaOpen source code (in the ",(0,i.jsx)(t.code,{children:"TuyaOpen/src"})," directory). This generates the application static library (",(0,i.jsx)(t.code,{children:"libtuyaapp.a"}),") and the SDK static library (",(0,i.jsx)(t.code,{children:"libtuyaos.a"}),")."]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.code,{children:"platform/Ubuntu/build_example.py"})," script is then called to invoke the vendor's build and linking commands, ultimately producing three types of firmware: QIO, UA, and UG."]}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"Firmware name"}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"Firmware type"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"app_name_QIO_1.0.0"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"Bootloader + user area firmware"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"app_name_UA_1.0.0"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"User area firmware"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"app_name_UG_1.0.0"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"Update firmware"})]})]})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["For a more detailed flow, refer to the ",(0,i.jsx)(t.a,{href:"/docs/build-system/compilation-guide",children:"TuyaOpen Compilation Flow Detailed Guide"}),"."]}),"\n",(0,i.jsx)(t.p,{children:"Generally, adapting a new chipset on TuyaOpen involves the following steps:"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsx)(t.li,{children:"Create a new platform and develop scripts to download the toolchain and handle build and linking."}),"\n",(0,i.jsx)(t.li,{children:"Complete the TKL adaptation."}),"\n",(0,i.jsx)(t.li,{children:"Create a new board."}),"\n",(0,i.jsxs)(t.li,{children:["Finalize configuration and test features in the ",(0,i.jsx)(t.code,{children:"apps/tuya_cloud/switch_demo"})," project to verify whether the adaptation was successful."]}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"create-a-platform",children:"Create a platform"}),"\n",(0,i.jsxs)(t.p,{children:["For the detailed procedure, refer to ",(0,i.jsx)(t.a,{href:"/docs/new-hardware/new-platform",children:"Create Platform"}),"."]}),"\n",(0,i.jsxs)(t.p,{children:["Within the ",(0,i.jsx)(t.code,{children:"menuconfig"})," interface, pay special attention to the following two items. Select other items based on specific hardware conditions."]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"ENABLE_FLASH"}),": ",(0,i.jsx)(t.strong,{children:"Must be enabled"}),". You need to reserve an unused section of flash memory for TuyaOpen. Avoid the firmware area and match the flash erase/write granularity."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"ENABLE_FILE_SYSTEM"}),": If you intend to use the vendor SDK's file system, adapt the ",(0,i.jsx)(t.code,{children:"tkl_fs.c"})," file. If this item is disabled, TuyaOpen will use its internal LittleFS file system, whose address and size are configured and provided by ",(0,i.jsx)(t.code,{children:"tkl_flash.c"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(t.admonition,{type:"tip",children:[(0,i.jsx)(t.p,{children:"Why is it necessary to reserve an unused section of flash memory?"}),(0,i.jsx)(t.p,{children:"Both TuyaOpen and TuyaOS require storage space for device authorization information. Furthermore, after a device is successfully paired and activated, certain device information, keys, and other data must be saved to the flash memory. To ensure power-loss safety for the file system, TuyaOpen employs the open-source LittleFS with AEC128 CBC encryption.TuyaOS uses a self-developed KV (key-value) file system. Both systems are secure and reliable. To facilitate you in quickly switching between the TuyaOpen and TuyaOS SDKs (as their TKL adaptation layer interfaces are consistent) while maintaining considerations for security, stability, and ease of transition, it is necessary to reserve a dedicated, unused flash region for TuyaOpen."})]}),"\n",(0,i.jsx)(t.h2,{id:"tkl-layer-adaptation",children:"TKL layer adaptation"}),"\n",(0,i.jsxs)(t.p,{children:["For TKL layer adaptation, refer to ",(0,i.jsx)(t.a,{href:"/docs/new-hardware/new-platform#fill-in-the-code",children:"Fill in the code"})," and ",(0,i.jsx)(t.a,{href:"https://developer.tuya.com/en/docs/iot-device-dev/TuyaOS-translation_rtos?id=Kcrwraf21847l",children:"Port TuyaOS to RTOS Platforms"}),". Please note that the vendor SDK may already integrate lwIP and Mbed TLS. You can choose to use either the vendor's version or TuyaOpen's version based on your specific situation."]}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:"How to select"}),": In the application project directory ",(0,i.jsx)(t.code,{children:"apps/tuya_cloud/switch_demo"}),", run ",(0,i.jsx)(t.code,{children:"tos.py config menu"})," to open the visual configuration interface."]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:["Go to ",(0,i.jsx)(t.code,{children:"configure tuyaopen"})," > ",(0,i.jsx)(t.code,{children:"configure enable/disable liblwip"})," to enable or disable the lwIP feature."]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:["When this item is disabled (using the vendor's lwIP), you need to adapt the ",(0,i.jsx)(t.code,{children:"tkl_network.c"})," file. You can refer to the adaptation method used in ",(0,i.jsx)(t.a,{href:"https://github.com/tuya/TuyaOpen-esp32/blob/master/tuya_open_sdk/tuyaos_adapter/src/drivers/tkl_network.c",children:"TuyaOpen-ESP32"}),", where the vendor's lwip is employed."]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:["When this item is enabled (using TuyaOpen's lwIP), you need to adapt the ",(0,i.jsx)(t.code,{children:"tkl_lwip.c"})," file. You can refer to the adaptation method used in ",(0,i.jsx)(t.a,{href:"https://github.com/tuya/TuyaOpen-T2/blob/master/tuyaos/tuyaos_adapter/src/tkl_lwip.c",children:"TuyaOpen-T2"}),", where TuyaOpen's lwIP is employed."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["Adapt ",(0,i.jsx)(t.strong,{children:"only one"})," of these two files based on your actual configuration. For more information, see ",(0,i.jsx)(t.a,{href:"https://developer.tuya.com/en/docs/iot-device-dev/TuyaOS-translation_rtos?id=Kcrwraf21847l#title-16-Adapt%20the%20network%20interface",children:"Adapt the network interface"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:["Go to ",(0,i.jsx)(t.code,{children:"configure tuyaopen"})," > ",(0,i.jsx)(t.code,{children:"configure mbedtls"})," > ",(0,i.jsx)(t.code,{children:"Enable user custom"})," to enable or disable the TuyaOpen Mbed TLS feature."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"adapt-tkl-interfaces-for-cellular-networks",children:"Adapt TKL interfaces for cellular networks"}),"\n",(0,i.jsxs)(t.p,{children:["To support this functionality, you must enable the ",(0,i.jsx)(t.code,{children:"ENABLE_CELLULAR"})," option when creating the platform template. The minimum required adaptation file directory for the cellular network is as follows:"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.code,{children:"tkl_cellular_base.c"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.code,{children:"tkl_cellular_comm.c"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.code,{children:"tkl_cellular_mds.c"})}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["For cellular network chips, TuyaOpen has already adapted the L511C module. You can download the ",(0,i.jsx)(t.a,{href:"https://github.com/tuya/TuyaOpen/tree/dev-cellular",children:"dev-cellular branch"})," for reference or use the L511C module directly. Refer to the ",(0,i.jsx)(t.a,{href:"https://github.com/shiliu-yang/TuyaOpen-L511C/tree/dev",children:"platform repository for L511C"}),"."]}),"\n",(0,i.jsxs)(t.p,{children:["You can base on either the TuyaOpen ",(0,i.jsx)(t.code,{children:"dev-cellular"})," branch or the ",(0,i.jsx)(t.code,{children:"dev"})," branch to adapt cellular network chips."]}),"\n",(0,i.jsx)(t.h2,{id:"create-a-board",children:"Create a board"}),"\n",(0,i.jsxs)(t.p,{children:["For specific steps, refer to ",(0,i.jsx)(t.a,{href:"/docs/new-hardware/new-board",children:"Create Board"}),"."]}),"\n",(0,i.jsxs)(t.p,{children:["After the board is created, and the configuration has been ",(0,i.jsx)(t.a,{href:"/docs/new-hardware/new-board#adjust-configuration",children:"adjusted"})," and ",(0,i.jsx)(t.a,{href:"/docs/new-hardware/new-board#save-configuration",children:"saved"}),", you can select the corresponding development board in the ",(0,i.jsx)(t.code,{children:"apps/tuya_cloud/switch_demo"})," directory using the ",(0,i.jsx)(t.code,{children:"tos.py config choice"})," command. Then proceed to the next step: Verify functionality."]}),"\n",(0,i.jsx)(t.h2,{id:"verify-functionality",children:"Verify functionality"}),"\n",(0,i.jsxs)(t.p,{children:["Before using ",(0,i.jsx)(t.code,{children:"tos.py build"})," to compile the ",(0,i.jsx)(t.code,{children:"switch_demo"})," code, ensure the following:"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.code,{children:"tuya_app_main()"})," function in the ",(0,i.jsx)(t.code,{children:"apps/tuya_cloud/switch_demo/src/tuya_main.c"})," file is being called by the vendor SDK."]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:["Update the authorization information macros ",(0,i.jsx)(t.code,{children:"TUYA_OPENSDK_UUID"})," and ",(0,i.jsx)(t.code,{children:"TUYA_OPENSDK_AUTHKEY"})," in the ",(0,i.jsx)(t.code,{children:"apps/tuya_cloud/switch_demo/src/tuya_config.h"})," file. For how to obtain authorization information, refer to the ",(0,i.jsx)(t.a,{href:"/docs/quick-start/#tuyaopen-authorization-code-acquisition",children:"TuyaOpen license"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:["For platforms adapted with cellular or wired networks, binding requires scanning a QR code via the ",(0,i.jsx)(t.strong,{children:"SmartLife"})," or ",(0,i.jsx)(t.strong,{children:"Tuya"})," app. ",(0,i.jsx)(t.a,{href:"/docs/quick-start/device-network-configuration#download-app",children:"Click to see how to download and operate the app"}),". The QR code URL can be printed using the following code snippet:"]}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.code,{children:"apps/tuya_cloud/switch_demo/src/tuya_main.c:107"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-c",children:'char buffer[255];\nsnprintf(buffer, sizeof(buffer), "https://smartapp.tuya.com/s/p?p=%s&uuid=%s&v=2.0", TUYA_PRODUCT_ID,\n         license.uuid);\nPR_INFO("QR link: %s", buffer);\n'})}),"\n"]}),"\n"]})]})}function h(e={}){let{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},8453(e,t,n){n.d(t,{R:()=>o,x:()=>s});var r=n(6540);let i={},a=r.createContext(i);function o(e){let t=r.useContext(a);return r.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(a.Provider,{value:t},e.children)}}}]);